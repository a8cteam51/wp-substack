(()=>{"use strict";const e=window.React,t=window.wp.plugins,o=window.wp.editPost,n=window.wp.components,l=window.wp.data,r=window.wp.i18n,s=window.wp.element,i=async e=>{try{return await wp.apiFetch({path:`/wp/v2/media/${e}`})}catch(e){return console.error("Error fetching video details:",e),null}},c=async e=>{const t=await fetch(e),o=await t.blob();return new Promise(((e,t)=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.onerror=t,n.readAsDataURL(o)}))},a=async e=>{if(!(e=>e.includes("<img"))(e))return e;const t=document.createElement("div");t.innerHTML=e;const o=t.querySelectorAll("img");for(const e of o){const t=e.src;if(t&&!t.startsWith("data:"))try{console.log("Processing image in HTML:",t);const o=await c(t);e.src=o,console.log("Successfully converted image to base64")}catch(e){console.error("Error converting image to base64:",e)}}return t.innerHTML},u=async e=>{let t="";for(const o of e)switch(o.name){case"core/paragraph":t+=`<p>${o.attributes.content}</p>\n\n`;break;case"core/heading":const e=o.attributes.level||2;t+=`<h${e}>${o.attributes.content}</h${e}>\n\n`;break;case"core/image":const n=o.attributes.url;try{t+=`<img src="${await c(n)}" alt="Image" />\n\n`}catch(e){console.error("Error processing image block:",e),t+=`<img src="${n}" alt="Image" />\n\n`}break;case"wp:videopress/video":case"videopress/video":const l=o.attributes;let r="";if(l.src)r=l.src;else if(l.id){const e=await i(l.id);e&&e.source_url&&(r=e.source_url)}r?t+=`<video src="${r}" controls></video>\n\n`:console.warn("VideoPress block found, but no video source available");break;case"core/video":t+=`<video src="${o.attributes.src}" controls></video>\n\n`;break;case"core/pullquote":let s="",g="";console.log("Pullquote block data:",o),console.log("Block innerHTML:",o.innerHTML),console.log("Block attributes:",o.attributes),console.log("Block innerBlocks:",o.innerBlocks),o.attributes.value&&(console.log("Using attributes.value method"),s="string"==typeof o.attributes.value?o.attributes.value.trim():o.attributes.value.originalHTML?o.attributes.value.originalHTML.trim():o.attributes.value.toString().trim(),console.log("Extracted value content:",s)),o.attributes.citation&&(g="string"==typeof o.attributes.citation?o.attributes.citation.trim():o.attributes.citation.originalHTML?o.attributes.citation.originalHTML.trim():o.attributes.citation.toString().trim(),console.log("Extracted citation:",g)),console.log("Final pullquote content:",s),console.log("Final citation:",g),""!==g.trim()&&(s+=` <p><em> ${g}</em></p>`),console.log("Final combined content:",s),t+=`<blockquote class="wp-block-quote"><p>${s}</p></blockquote>\n\n`;break;case"core/embed":let b="";if(o.attributes&&o.attributes.url)b=o.attributes.url,console.log("Found embed URL in attributes:",b);else if(o.innerHTML&&""!==o.innerHTML.trim()){const e=document.createElement("div");e.innerHTML=o.innerHTML;const t=e.querySelector(".wp-block-embed__wrapper");t&&(b=t.textContent.trim(),console.log("Found embed URL in HTML wrapper:",b))}console.log("Final embed URL:",b),b?t+=`<p>${b}</p>\n\n`:console.log("No embed URL found, skipping embed block");break;case"core/list":const m=o.attributes.ordered?"ol":"ul",p=e=>{let t="";for(const o of e)if("core/list-item"===o.name){let e=o.attributes.content||"";if(o.innerBlocks&&o.innerBlocks.length>0)for(const t of o.innerBlocks)if("core/list"===t.name){const o=t.attributes.ordered?"ol":"ul";e+=`\n<${o}>\n${p(t.innerBlocks)}</${o}>`}t+=`<li>${e}</li>\n`}return t};let d=`<${m}>\n`;o.innerBlocks&&o.innerBlocks.length>0&&(d+=p(o.innerBlocks)),d+=`</${m}>\n\n`,t+=d;break;case"core/buttons":if(console.log("Processing buttons block:",o),o.innerBlocks&&o.innerBlocks.length>0){for(const e of o.innerBlocks)if("core/button"===e.name){console.log("Processing button block:",e);let o="",n="";e.attributes&&e.attributes.text&&(o=e.attributes.text),e.attributes&&e.attributes.url&&(n=e.attributes.url),console.log("Button details:",{text:o,url:n}),o&&n&&(t+=`<div class="wp-block-button"><a class="wp-block-button__link wp-element-button" href="${n}">${o}</a></div>\n\n`)}}else t+=`${wp.blocks.serialize([o])}\n\n`;break;case"core/button":console.log("Processing individual button block:",o);let k="",f="";o.attributes&&o.attributes.text&&(k=o.attributes.text),o.attributes&&o.attributes.url&&(f=o.attributes.url),console.log("Individual button details:",{text:k,url:f}),t+=k&&f?`<div class="wp-block-button"><a class="wp-block-button__link wp-element-button" href="${f}">${k}</a></div>\n\n`:`${wp.blocks.serialize([o])}\n\n`;break;case"core/file":console.log("Processing file block:",o);let w="",h="",y=!0;if(o.attributes&&(w=o.attributes.href||"",h=o.attributes.fileName||"",y=!1!==o.attributes.showDownloadButton),!w||!h){console.log("Extracting file info from innerHTML");const e=document.createElement("div");e.innerHTML=o.innerHTML;const t=e.querySelector("a");t&&(w=t.getAttribute("href")||w,h=t.textContent.trim()||h),y=!!e.querySelector(".wp-block-file__button")}console.log("File details:",{url:w,name:h,hasButton:y}),w&&h?t+=y?`<div class="wp-block-button"><a class="wp-block-button__link wp-element-button" href="${w}">${h}</a></div>\n\n`:`<p><a href="${w}">${h}</a></p>\n\n`:(console.log("Failed to extract file info, using raw content"),t+=`${wp.blocks.serialize([o])}\n\n`);break;case"core/html":console.log("Processing HTML block:",o);let $="";if(o.attributes&&o.attributes.content?($=o.attributes.content.trim(),console.log("HTML content from attributes:",$)):o.innerHTML&&""!==o.innerHTML.trim()&&($=o.innerHTML.trim(),console.log("HTML content from innerHTML:",$)),$){const e=document.createElement("div");e.innerHTML=$;const o=e.firstChild,n=["div","p","h1","h2","h3","h4","h5","h6","blockquote","pre","ul","ol","li","section","article","header","footer","main","aside"];let l=!0;if(o&&o.nodeType===Node.ELEMENT_NODE){const t=o.tagName.toLowerCase();n.includes(t)&&1===e.children.length&&(l=!1,console.log("HTML content already properly wrapped in block-level tag:",t))}l?(console.log("Wrapping HTML content in <p> tags"),t+=`<p>${$}</p>\n\n`):(console.log("Using HTML content as-is"),t+=`${$}\n\n`)}else console.log("No HTML content found, using raw content"),t+=`${wp.blocks.serialize([o])}\n\n`;break;case"core/details":console.log("Processing details block:",o);let v="",B="";if(o.attributes&&o.attributes.summary&&(v=o.attributes.summary.trim(),console.log("Details summary from attributes:",v)),o.innerBlocks&&o.innerBlocks.length>0&&(console.log("Processing details inner blocks:",o.innerBlocks.length),B=await u(o.innerBlocks),console.log("Processed details content:",B)),!v&&o.innerHTML){console.log("Extracting details info from innerHTML");const e=document.createElement("div");e.innerHTML=o.innerHTML;const t=e.querySelector("summary");t&&(v=t.textContent.trim(),console.log("Extracted summary from HTML:",v))}v?(t+=`<p><strong>â–¶ ${v}</strong></p>\n\n`,B&&B.trim()&&(t+=B.replace(/<p>/g,"<p><em>").replace(/<\/p>/g,"</em></p>").replace(/<h([1-6])>/g,"<h$1><em>").replace(/<\/h([1-6])>/g,"</em></h$1>").replace(/<li>/g,"<li><em>").replace(/<\/li>/g,"</em></li>"))):(console.log("No summary content found, using raw content"),t+=`${wp.blocks.serialize([o])}\n\n`);break;case"core/media-text":if(console.log("Processing media-text block:",o),o.innerBlocks&&o.innerBlocks.length>0){console.log("Processing media-text inner blocks:",o.innerBlocks.length);const e=await u(o.innerBlocks);let n="";if(o.attributes&&o.attributes.mediaUrl)try{n=`<img src="${await c(o.attributes.mediaUrl)}" alt="${o.attributes.mediaAlt||"Media"}" />\n\n`}catch(e){console.error("Error processing media-text image:",e),n=`<img src="${o.attributes.mediaUrl}" alt="${o.attributes.mediaAlt||"Media"}" />\n\n`}t+=`${n}${e}`}else{const e=wp.blocks.serialize([o]);t+=`${await a(e)}\n\n`}break;case"core/columns":if(console.log("Processing columns block:",o),o.innerBlocks&&o.innerBlocks.length>0)console.log("Processing columns inner blocks:",o.innerBlocks.length),t+=await u(o.innerBlocks);else{const e=wp.blocks.serialize([o]);t+=`${await a(e)}\n\n`}break;case"core/column":if(console.log("Processing column block:",o),o.innerBlocks&&o.innerBlocks.length>0)console.log("Processing column inner blocks:",o.innerBlocks.length),t+=await u(o.innerBlocks);else{const e=wp.blocks.serialize([o]);t+=`${await a(e)}\n\n`}break;case"core/group":console.log("Processing group block:",o),console.log("Group block attributes:",o.attributes);let L="";if(o.attributes?.style?.background?.backgroundImage?.url){const e=o.attributes.style.background.backgroundImage.url;try{console.log("Processing group background image:",e),L+=`<img src="${await c(e)}" alt="Group background" />\n\n`}catch(t){console.error("Error processing group background image:",t),L+=`<img src="${e}" alt="Group background" />\n\n`}}if(o.innerBlocks&&o.innerBlocks.length>0)console.log("Processing group inner blocks:",o.innerBlocks.length),L+=await u(o.innerBlocks);else{const e=wp.blocks.serialize([o]);L+=`${await a(e)}\n\n`}t+=L;break;case"core/cover":console.log("Processing cover block:",o);let M="";if(o.attributes&&o.attributes.url)try{M+=`<img src="${await c(o.attributes.url)}" alt="${o.attributes.alt||"Cover Image"}" />\n\n`}catch(e){console.error("Error processing cover image:",e),M+=`<img src="${o.attributes.url}" alt="${o.attributes.alt||"Cover Image"}" />\n\n`}o.innerBlocks&&o.innerBlocks.length>0&&(console.log("Processing cover inner blocks:",o.innerBlocks.length),M+=await u(o.innerBlocks)),t+=M;break;case"core/gallery":console.log("Processing gallery block:",o),console.log("Gallery block attributes:",o.attributes),console.log("Gallery block innerBlocks:",o.innerBlocks),console.log("Gallery block innerHTML:",o.innerHTML);let T=[];if(o.attributes&&o.attributes.images&&Array.isArray(o.attributes.images)&&(console.log("Found images in block.attributes.images:",o.attributes.images.length),T=o.attributes.images.map((e=>({url:e.url,alt:e.alt||"",caption:e.caption||""})))),0===T.length&&o.innerBlocks&&o.innerBlocks.length>0){console.log("Looking for images in inner blocks:",o.innerBlocks.length);for(const e of o.innerBlocks)"core/image"===e.name&&e.attributes&&e.attributes.url&&T.push({url:e.attributes.url,alt:e.attributes.alt||"",caption:e.attributes.caption||""})}if(0===T.length){console.log("Parsing images from serialized HTML");const e=wp.blocks.serialize([o]);console.log("Gallery serialized content:",e);const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll("img").forEach((e=>{e.src&&T.push({url:e.src,alt:e.alt||"",caption:""})}))}if(console.log("Final gallery images found:",T.length),console.log("Gallery images data:",T),T.length>0){const e=[];for(const t of T)try{const o=await c(t.url);e.push({base64:o,alt:t.alt,caption:t.caption})}catch(o){console.error("Error processing gallery image:",o),e.push({base64:t.url,alt:t.alt,caption:t.caption})}t+=`<div class="wp-substack-gallery" data-gallery='${JSON.stringify(e).replace(/'/g,"&apos;")}' style="display: none;">GALLERY_MARKER</div>\n\n`}else console.log("No gallery images found, skipping gallery block");break;case"core/table":console.log("Processing table block:",o);const E=document.createElement("div"),H=wp.blocks.serialize([o]);E.innerHTML=H;let P="";const S=E.querySelectorAll("th");S.length>0&&(P+=`<p><strong>${Array.from(S).map((e=>e.textContent.trim())).join(" | ")}</strong></p>\n\n`);const _=E.querySelectorAll("tr");for(const e of _){if(e.querySelector("th"))continue;const t=e.querySelectorAll("td");if(0===t.length)continue;const o=[],n=[];for(const e of t){const t=e.querySelectorAll("img");for(const e of t){try{const t=await c(e.src);n.push({html:`<img src="${t}" alt="${e.alt||"Table cell image"}" />`,originalNode:e})}catch(t){console.error("Error processing table cell image:",t),n.push({html:e.outerHTML,originalNode:e})}e.remove()}const l=e.textContent.trim();o.push(l||"blank")}o.some((e=>"blank"!==e))&&(P+=`<p>${o.join(" | ")}</p>\n\n`);for(const e of n)P+=`${e.html}\n\n`}t+=`${P}<p>---</p>\n\n`;break;default:console.log("Processing block via default case:",o.name);const x=wp.blocks.serialize([o]);t+=`${await a(x)}\n\n`}return t},g=(0,l.withSelect)((e=>{const t=e("core/editor"),o=e("core/block-editor").getBlocks(),n=t.getEditedPostAttribute("featured_media");let l="";if(n){const t=e("core").getMedia(n);t&&(l=t.source_url)}const r=t.getEditedPostAttribute("excerpt");return{postTitle:t.getEditedPostAttribute("title"),postBlocks:o,featuredImageUrl:l,postExcerpt:null!=r?r:""}}))((({postTitle:t,postBlocks:l,featuredImageUrl:i,postExcerpt:a})=>{const[g,b]=(0,s.useState)([]),[m,p]=(0,s.useState)(""),[d,k]=(0,s.useState)(!1);return(0,s.useEffect)((()=>{(async()=>{const e=await wp.apiFetch({path:"/wp/v2/substack_publications"});e&&b(e.map((e=>({label:e,value:e}))))})()}),[]),(0,e.createElement)(o.PluginDocumentSettingPanel,{className:"publish_to_substack",title:(0,r.__)("Publish to Substack","a8csp-wp-substack")},(0,e.createElement)(n.SelectControl,{label:(0,r.__)("Select Substack Publication","a8csp-wp-substack"),value:m,options:g,onChange:e=>p(e)}),(0,e.createElement)("div",null,(0,e.createElement)("label",null,(0,e.createElement)("input",{type:"checkbox",checked:d,onChange:()=>k(!d)}),(0,r.__)("Open in debug mode","a8csp-wp-substack"))),(0,e.createElement)(n.Button,{isPrimary:!0,onClick:async()=>{console.log("Initial content:",l);let e=await u(l);console.log("After processing blocks:",e);const o=await(async e=>{if(!e)return null;try{return await c(e)}catch(e){return console.error("Error fetching featured image as base64:",e),null}})(i);console.log("Final content being sent:",e),window.postMessage({action:"wp2substackSaveContent",data:{title:t,content:e,publication:m||g[0].value,featuredImageBase64:o,postExcerpt:a,debugMode:d}},"*")}},(0,r.__)("Send to Substack","a8csp-wp-substack")))}));(0,t.registerPlugin)("a8csp-wp-substack",{render:g})})();